<html><head><link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script></head><body><h1 id="GitHub"><a href="#GitHub" class="headerlink" title="GitHub"></a>GitHub</h1><p><strong><a href="https://github.com/Raptor1998/uploader" target="_blank" rel="noopener">https://github.com/Raptor1998/uploader</a></strong></p>
<h1 id="Uploader"><a href="#Uploader" class="headerlink" title="Uploader"></a>Uploader</h1><h2 id="environment"><a href="#environment" class="headerlink" title="environment"></a>environment</h2><ul>
<li>Springboot 2.3.5 </li>
<li>Mybatis 1.3.2</li>
</ul>
<h2 id="content-path"><a href="#content-path" class="headerlink" title="content-path"></a>content-path</h2><p><code>/api/uploader</code></p>
<h2 id="upload-request-process"><a href="#upload-request-process" class="headerlink" title="upload request process"></a>upload request process</h2><h3 id="second-upload"><a href="#second-upload" class="headerlink" title="second upload"></a>second upload</h3><ol>
<li>计算文件的md5值，查询是否已经存在</li>
<li>是，根据文件名称和md5值实现秒传；否，直接上传</li>
</ol>
<h3 id="block-upload"><a href="#block-upload" class="headerlink" title="block upload"></a>block upload</h3><ol>
<li><p>计算文件md5值，根据需求切片，得到总片数</p>
</li>
<li><pre><code class="java"><span class="comment">/**</span>
<span class="comment"> * 分块上传</span>
<span class="comment"> *</span>
<span class="comment"> * <span class="doctag">@param</span> originalName 文件原名</span>
<span class="comment"> * <span class="doctag">@param</span> file         文件</span>
<span class="comment"> * <span class="doctag">@param</span> chunks       共分几块</span>
<span class="comment"> * <span class="doctag">@param</span> chunk        第几块</span>
<span class="comment"> * <span class="doctag">@param</span> size         文件总大小</span>
<span class="comment"> * <span class="doctag">@param</span> md5          文件的md5</span>
<span class="comment"> * <span class="doctag">@return</span></span>
<span class="comment"> */</span>
<span class="meta">@PostMapping</span>(<span class="string">"/block/single"</span>)
<span class="function"><span class="keyword">public</span> Result <span class="title">uploadBigSingleFile</span><span class="params">(@RequestParam(<span class="string">"originalName"</span>)</span> String originalName,</span>
<span class="function">                                  @<span class="title">RequestParam</span><span class="params">(<span class="string">"file"</span>)</span> MultipartFile file,</span>
<span class="function">                                  @<span class="title">RequestParam</span><span class="params">(<span class="string">"chunks"</span>)</span> Integer chunks,</span>
<span class="function">                                  @<span class="title">RequestParam</span><span class="params">(<span class="string">"chunk"</span>)</span> Integer chunk,</span>
<span class="function">                                  @<span class="title">RequestParam</span><span class="params">(<span class="string">"size"</span>)</span> Long size,</span>
<span class="function">                                  @<span class="title">RequestParam</span><span class="params">(<span class="string">"md5"</span>)</span> String md5) </span>{
    uploaderService.uploadWithBlock(originalName, file, chunks, size, chunk, md5);
    <span class="keyword">return</span> ResultUtil.success(<span class="keyword">null</span>);
}
&lt;!--￼<span class="number">0</span>--&gt;
</code></pre>
</li>
</ol>
<h1 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for block_file</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`block_file`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`block_file`</span>  (</span><br><span class="line">                               <span class="string">`block_file_id`</span> <span class="built_in">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">                               <span class="string">`block_file_chunk`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'第几块'</span>,</span><br><span class="line">                               <span class="string">`block_file_md5`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'md5'</span>,</span><br><span class="line">                               <span class="string">`upload_time`</span> <span class="built_in">timestamp</span>(<span class="number">0</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>(<span class="number">0</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>(<span class="number">0</span>) <span class="keyword">COMMENT</span> <span class="string">'上传时间'</span>,</span><br><span class="line">                               <span class="string">`temp_path`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'临时文件的存储位置'</span>,</span><br><span class="line">                               PRIMARY <span class="keyword">KEY</span> (<span class="string">`block_file_id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">                               <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> <span class="string">`block_file_chunk`</span>(<span class="string">`block_file_chunk`</span>, <span class="string">`block_file_md5`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> AUTO_INCREMENT = <span class="number">1</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for file_info</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`file_info`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`file_info`</span>  (</span><br><span class="line">                              <span class="string">`file_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'文件详情'</span>,</span><br><span class="line">                              <span class="string">`file_original_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'原文件名'</span>,</span><br><span class="line">                              <span class="string">`file_union_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'唯一标识'</span>,</span><br><span class="line">                              <span class="string">`file_real_path`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'真实路径'</span>,</span><br><span class="line">                              <span class="string">`file_suffix`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'拓展名'</span>,</span><br><span class="line">                              <span class="string">`file_url`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'网络地址'</span>,</span><br><span class="line">                              <span class="string">`file_size`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'文件大小'</span>,</span><br><span class="line">                              <span class="string">`file_upload_time`</span> <span class="built_in">timestamp</span>(<span class="number">0</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>(<span class="number">0</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>(<span class="number">0</span>) <span class="keyword">COMMENT</span> <span class="string">'上传时间'</span>,</span><br><span class="line">                              <span class="string">`md5`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'文件的md5值'</span>,</span><br><span class="line">                              PRIMARY <span class="keyword">KEY</span> (<span class="string">`file_id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">                              <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> <span class="string">`file_union_name`</span>(<span class="string">`file_union_name`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> AUTO_INCREMENT = <span class="number">1</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8 <span class="keyword">COLLATE</span> = utf8_general_ci ROW_FORMAT = <span class="keyword">Compact</span>;</span><br></pre></td></tr></tbody></table></figure></div>



<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p><a href="https://www.jianshu.com/p/d58d275ac1f4?ivk_sa=1024320u" target="_blank" rel="noopener">文件上传工具类（JAVA）</a></p>
<p><a href="https://github.com/gaoyuyue/MyUploader-Backend" target="_blank" rel="noopener">gaoyuyue/MyUploader-Backend</a></p>
</body></html>